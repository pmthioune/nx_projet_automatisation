from pyspark.sql import SparkSession
from pyspark.sql.functions import sum as spark_sum

# Initialiser Spark
spark = SparkSession.builder.appName("OptimizedFiltrageNotes").getOrCreate()

# Exemple de DataFrame
data = [("TP001", 0, 15), ("TP001", 0, 10), ("TP002", 5, 12), 
        ("TP003", 0, 0), ("TP003", 0, 0), ("TP004", 8, 14), 
        ("TP005", 0, 0), ("TP005", 0, 5)]

df = spark.createDataFrame(data, ["thirdparty_code", "note_sg", "note_cdn"])

# Suppression des thirdparty_code oÃ¹ sum(note_sg) == 0
df_filtre_sg = df.join(
    df.groupBy("thirdparty_code").agg(spark_sum("note_sg").alias("sum_note_sg"))
      .filter("sum_note_sg > 0")
      .select("thirdparty_code"),
    on="thirdparty_code",
    how="inner"
)

# Suppression des thirdparty_code oÃ¹ sum(note_cdn) == 0
df_filtre_cdn = df.join(
    df.groupBy("thirdparty_code").agg(spark_sum("note_cdn").alias("sum_note_cdn"))
      .filter("sum_note_cdn > 0")
      .select("thirdparty_code"),
    on="thirdparty_code",
    how="inner"
)

# Affichage des rÃ©sultats
print("ğŸ”¹ AprÃ¨s suppression par note_sg :")
df_filtre_sg.show()

print("ğŸ”¹ AprÃ¨s suppression par note_cdn :")
df_filtre_cdn.show()








