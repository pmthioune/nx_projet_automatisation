# module_losses_extractor.py

import pandas as pd
import re

def extract_vintage_tables(filepath, max_rows=1000):
    """
    Extrait les blocs 'YE Vintage' de l'onglet 'Losses' du fichier Excel.

    Args:
        filepath (str): Chemin du fichier Excel.
        max_rows (int, optional): Nombre maximum de lignes à lire. Par défaut 1000.

    Returns:
        dict: {vintage_title: DataFrame}
    """

    # Lire seulement la colonne B à Z, 1000 premières lignes
    df = pd.read_excel(filepath, sheet_name='Losses', header=None, skiprows=1, usecols="B:Z", nrows=max_rows)
    
    # Correction erreurs éventuelles "g" => "9"
    df = df.replace('g', '9', regex=True)

    # Trouver où commencent les Vintage
    vintage_indices = df.index[df[1].astype(str).str.contains(r'\d{4} YE vintage', case=False, na=False)].tolist()
    vintage_indices.append(len(df))  # Ajouter fin fichier pour terminer le dernier bloc

    tables = {}
    
    for i in range(len(vintage_indices) - 1):
        start = vintage_indices[i]
        end = vintage_indices[i+1]

        # Nom du vintage
        vintage_title = str(df.iloc[start, 1]).strip()

        # Lire colonnes (normalement juste après le titre)
        columns = df.iloc[start + 1, 1:].tolist()

        # Lire les données : de start+2 jusqu'à end
        data = df.iloc[start + 2:end, 1:]
        data.columns = columns

        # Ajouter le Vintage et son DataFrame
        tables[vintage_title] = data.reset_index(drop=True)

    return tables
