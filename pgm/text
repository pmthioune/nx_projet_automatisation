# module_losses_extractor.py

import pandas as pd
import re

def extract_tables_from_losses(filepath):
    """
    Extrait les tableaux de l'onglet 'Losses' d'un fichier Excel.

    Args:
        filepath (str): Chemin du fichier Excel.

    Returns:
        dict: Dictionnaire contenant les tableaux extraits sous forme de DataFrames.
    """

    sheet_name = 'Losses'

    # Lire la feuille sans header
    df = pd.read_excel(filepath, sheet_name=sheet_name, header=None)

    # Corriger quelques erreurs connues si nécessaire
    df = df.applymap(lambda x: str(x).replace('g', '9') if isinstance(x, str) else x)

    # Trouver les indices où un tableau commence
    indices_blocs = df.index[df[0].astype(str).str.match(r'^\d{4}-12|^\d{4} YE vintage$', na=False)].tolist()

    # Ajouter la fin pour découper jusqu'à la dernière ligne
    indices_blocs.append(len(df))

    # Découper les blocs
    tableaux = {}
    for i in range(len(indices_blocs) - 1):
        debut = indices_blocs[i]
        fin = indices_blocs[i+1]
        bloc = df.iloc[debut:fin].reset_index(drop=True)

        titre = str(bloc.iloc[0, 0]).strip()
        tableaux[titre] = bloc

    return tableaux
